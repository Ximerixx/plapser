<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#7131c0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Plapser">
    <title>–ü–æ–∏—Å–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</title>
    <link rel="stylesheet" href="stylesheet.css">
    <link rel="manifest" href="/manifest.json">
    <style>
        .results-container {
            margin-top: 20px;
            padding: 20px;
            background: var(--border-light);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .lesson-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px var(--shadow);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .lesson-time {
            font-weight: bold;
            color: var(--primary);
            font-size: 18px;
        }
        
        .lesson-details {
            margin-top: 8px;
            color: var(--text);
            transition: color 0.3s ease;
        }
        
        .lesson-room {
            background: var(--secondary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            display: inline-block;
            margin-right: 10px;
        }
        
        .lesson-group {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            display: inline-block;
        }
        
        .no-lessons {
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            padding: 20px;
        }
        
        .teacher-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .teacher-name {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .search-date {
            color: var(--text-light);
            font-size: 14px;
            transition: color 0.3s ease;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
            transition: color 0.3s ease;
        }
        
        .error {
            background: var(--error);
            color: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--error);
            transition: background-color 0.3s ease;
        }
        
        .offline-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--error);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow);
            z-index: 999;
            display: none;
            font-size: 14px;
            max-width: 250px;
        }
        
        .offline-indicator.show {
            display: block;
        }
        
        .cache-warning {
            background: #ff9800;
            color: white;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            border-left: 4px solid #f57c00;
        }
        
        .cache-warning strong {
            display: block;
            margin-bottom: 5px;
        }
        
        .recent-teachers {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .recent-teachers-title {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        
        .recent-teachers-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .update-time {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
            text-align: center;
            transition: color 0.3s ease;
        }
        
        .update-time.stale {
            color: var(--error);
        }
        
        .update-progress {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 8px 15px;
            font-size: 11px;
            color: var(--text-light);
            z-index: 1000;
            display: none;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        
        .update-progress.show {
            display: block;
        }
        
        .recent-teacher-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .recent-teacher-btn:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }
    </style>
</head>

<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle">
        <button id="theme-toggle" class="theme-toggle-button" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
            üåô
        </button>
    </div>
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
    </div>

    <div class="container">
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/gui" class="button" style="display: inline-block; text-decoration: none; background: var(--text-light);">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—É
            </a>
        </div>
        
        <h1>–ì–¥–µ –ø—Ä–µ–ø–æ–¥?</h1>
        <p style="text-align: center; color: var(--text-light); margin-bottom: 30px;">
            –ê –≥–¥–µ –ø—Ä–µ–ø–æ–¥?
        </p>

        <div class="input-group">
            <input type="text" id="teacher" class="input-field" placeholder=" ">
            <button id="clear-teacher" class="button secondary small-button">√ó</button>
            <label class="input-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label>
            <ul id="teacher-list" class="dropdown"></ul>
        </div>


        <div class="input-group">
            <input type="date" id="date" class="input-field" placeholder=" ">
            <label class="input-label">–î–∞—Ç–∞</label>
        </div>

        <div class="checkbox-container">
            <input type="checkbox" id="weekParsing" class="checkbox">
            <label for="weekParsing">–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ –Ω–µ–¥–µ–ª—é </label>
        </div>

        <button id="search-teacher" class="button">–ù–∞–π—Ç–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</button>
        <div id="update-time" class="update-time" style="display: none;"></div>

        <div id="recent-teachers" class="recent-teachers" style="display: none;">
            <div class="recent-teachers-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∏—Å–∫–∏:</div>
            <div id="recent-teachers-grid" class="recent-teachers-grid">
                <!-- Recent teacher buttons will be populated here -->
            </div>
        </div>

        <div id="results" style="display: none;">
            <!-- Results will be populated here -->
        </div>
        
        <div id="update-progress" class="update-progress"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const teacherInput = document.getElementById('teacher');
            const teacherList = document.getElementById('teacher-list');
            const dateInput = document.getElementById('date');
            const weekParsingCheckbox = document.getElementById('weekParsing');
            const clearButton = document.getElementById('clear-teacher');
            const searchButton = document.getElementById('search-teacher');
            const resultsDiv = document.getElementById('results');

            let allTeachers = [];
            const recentTeachersDiv = document.getElementById('recent-teachers');
            const recentTeachersGrid = document.getElementById('recent-teachers-grid');

            const today = new Date();
            dateInput.valueAsDate = today;

            // Cookie functions
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            function setCookie(name, value, days = 365) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = `expires=${date.toUTCString()}`;
                document.cookie = `${name}=${value};${expires};path=/`;
            }

            function saveRecentTeacher(teacher) {
                if (!teacher || !teacher.trim()) return;
                
                const cookieValue = getCookie('recent_teachers');
                let recent = cookieValue ? JSON.parse(decodeURIComponent(cookieValue)) : [];
                
                // Remove if already exists
                recent = recent.filter(t => t !== teacher);
                // Add to beginning
                recent.unshift(teacher);
                // Keep only last 12
                recent = recent.slice(0, 12);
                
                setCookie('recent_teachers', encodeURIComponent(JSON.stringify(recent)));
                displayRecentTeachers();
            }

            function getRecentTeachers() {
                const cookieValue = getCookie('recent_teachers');
                if (!cookieValue) return [];
                try {
                    return JSON.parse(decodeURIComponent(cookieValue));
                } catch (e) {
                    return [];
                }
            }

            function displayRecentTeachers() {
                const recent = getRecentTeachers();
                if (recent.length === 0) {
                    recentTeachersDiv.style.display = 'none';
                    return;
                }

                recentTeachersDiv.style.display = 'block';
                recentTeachersGrid.innerHTML = '';

                recent.forEach(teacher => {
                    const btn = document.createElement('button');
                    btn.className = 'recent-teacher-btn';
                    btn.textContent = teacher;
                    btn.title = teacher;
                    btn.addEventListener('click', () => {
                        teacherInput.value = teacher;
                        teacherList.innerHTML = '';
                        searchTeacher();
                    });
                    recentTeachersGrid.appendChild(btn);
                });
            }

            // Load recent teachers on page load
            displayRecentTeachers();

            clearButton.addEventListener('click', function (e) {
                e.preventDefault();
                clearTeacherInput();
            });

            function clearTeacherInput() {
                teacherInput.value = '';
                teacherList.innerHTML = '';
                resultsDiv.style.display = 'none';
            }

            teacherInput.addEventListener('input', updateDropdown);

            searchButton.addEventListener('click', searchTeacher);

            async function fetchTeachers() {
                try {
                    const response = await fetch('/api/teachers');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allTeachers = await response.json();
                    updateDropdown();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π.');
                }
            }

            function updateDropdown() {
                const value = teacherInput.value.toLowerCase();
                teacherList.innerHTML = '';

                if (!value) return;

                const filtered = allTeachers.filter(teacher =>
                    teacher.toLowerCase().includes(value)
                ).slice(0, 10);

                filtered.forEach(teacher => {
                    const li = document.createElement('li');
                    li.textContent = teacher;
                    li.classList.add('dropdown-item');
                    li.addEventListener('click', () => {
                        teacherInput.value = teacher;
                        teacherList.innerHTML = '';
                    });
                    teacherList.appendChild(li);
                });
            }

            async function searchTeacher() {
                const teacher = teacherInput.value.trim();
                const date = dateInput.value;
                const weekParsing = weekParsingCheckbox.checked;

                if (!teacher) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ');
                    return;
                }

                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="loading">–ü–æ–∏—Å–∫...</div>';

                const requestStartTime = performance.now();

                try {
                    // Choose API type based on checkbox
                    const apiType = weekParsing ? 'json-week' : 'json';
                    let url = `/gen_teach?teacher=${encodeURIComponent(teacher)}&type=${apiType}`;
                    
                    if (date) {
                        url += `&date=${date}`;
                    }

                    const response = await fetch(url);
                    const requestEndTime = performance.now();
                    const requestDuration = requestEndTime - requestStartTime;

                    // Get cache headers
                    const cacheHit = response.headers.get('X-Cache-Hit') === 'true';
                    const cacheAge = response.headers.get('X-Cache-Age');
                    const cacheTTL = response.headers.get('X-Cache-TTL');
                    const offlineCache = response.headers.get('X-Offline-Cache') === 'true';
                    const cacheTimestamp = response.headers.get('X-Cache-Timestamp');

                    // Log request details
                    const logData = {
                        timestamp: new Date().toISOString(),
                        type: 'searchTeacher',
                        teacher: teacher,
                        date: date || 'today',
                        weekParsing: weekParsing,
                        requestDuration: `${requestDuration.toFixed(2)}ms`,
                        cacheHit: cacheHit,
                        cacheAge: cacheAge ? `${cacheAge}s` : null,
                        cacheTTL: cacheTTL ? `${cacheTTL}s` : null,
                        offlineCache: offlineCache,
                        statusCode: response.status,
                        url: url
                    };
                    console.log('[CLIENT LOG]', JSON.stringify(logData));

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è');
                    }

                    displayResults(data, teacher, date, weekParsing, offlineCache);
                    // Save to recent teachers
                    saveRecentTeacher(teacher);
                    
                    // Show update time
                    if (cacheTimestamp) {
                        showUpdateTime(parseInt(cacheTimestamp));
                    } else {
                        showUpdateTime(Date.now());
                    }

                } catch (error) {
                    const requestEndTime = performance.now();
                    const requestDuration = requestEndTime - requestStartTime;
                    
                    console.error('[CLIENT LOG ERROR]', JSON.stringify({
                        timestamp: new Date().toISOString(),
                        type: 'searchTeacher',
                        teacher: teacher,
                        error: error.message,
                        requestDuration: `${requestDuration.toFixed(2)}ms`
                    }));
                    
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <strong>–û—à–∏–±–∫–∞:</strong> ${error.message}
                        </div>
                    `;
                }
            }

            function displayResults(data, teacher, searchDate, weekParsing, offlineCache = false) {
                let html = `
                    <div class="results-container">
                        ${offlineCache ? `
                            <div class="cache-warning">
                                <strong>‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ñ–ª–∞–π–Ω –∫—ç—à–∞</strong>
                                –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—ã–ª–æ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ —Ä–∞–Ω–µ–µ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º. –û–±–Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.
                            </div>
                        ` : ''}
                        <div class="teacher-info">
                            <div class="teacher-name">${teacher}</div>
                            <div class="search-date">${weekParsing ? '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é' : (searchDate || '–°–µ–≥–æ–¥–Ω—è')}</div>
                        </div>
                `;

                if (weekParsing) {
                    // For week parsing, display all days with lessons
                    const dates = Object.keys(data).sort();
                    let totalLessons = 0;
                    let hasAnyLessons = false;

                    dates.forEach(dateKey => {
                        const dayData = data[dateKey];
                        if (dayData && dayData.lessons) {
                            const activeLessons = dayData.lessons.filter(lesson => 
                                lesson.time && lesson.time.includes('-') && !lesson.status
                            );
                            
                            if (activeLessons.length > 0) {
                                hasAnyLessons = true;
                                totalLessons += activeLessons.length;
                                html += `
                                    <div style="margin: 20px 0;">
                                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                                            ${dayData.date} (${dayData.dayOfWeek})
                                        </h3>
                                `;

                                activeLessons.forEach(lesson => {
                                    html += `
                                        <div class="lesson-card">
                                            <div class="lesson-time">${lesson.time || 'N/A'}</div>
                                            <div class="lesson-details">
                                                <strong>${lesson.subject || '–ó–∞–Ω—è—Ç–∏–µ'}</strong><br>
                                                ${lesson.room ? `<span class="lesson-room"> ${lesson.room}</span>` : ''}
                                                ${lesson.group ? `<span class="lesson-group"> ${lesson.group}</span>` : ''}
                                                ${lesson.subgroup ? ` <small>(${lesson.subgroup})</small>` : ''}
                                            </div>
                                        </div>
                                    `;
                                });

                                html += `</div>`;
                            }
                        }
                    });

                    if (!hasAnyLessons) {
                        html += `
                            <div class="no-lessons">
                                –£ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∑–∞–Ω—è—Ç–∏–π –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ
                            </div>
                        `;
                    } else {
                        html = `
                            <div class="results-container">
                                <div class="teacher-info">
                                    <div class="teacher-name">${teacher}</div>
                                    <div class="search-date">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é</div>
                                    <div style="margin-top: 10px; font-size: 14px;">
                                        <strong>–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π: ${totalLessons}</strong>
                                    </div>
                                </div>
                                ${html.split('<div class="teacher-info">')[1]}
                        `;
                    }
                } else {
                    // For single day parsing, display lessons for that day
                    const targetDate = searchDate || new Date().toISOString().split('T')[0];
                    const dayData = data[targetDate] || data;
                    
                    if (!dayData || !dayData.lessons || dayData.lessons.length === 0) {
                        html += `
                            <div class="no-lessons">
                                –£ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∑–∞–Ω—è—Ç–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
                            </div>
                        `;
                    } else {
                        const activeLessons = dayData.lessons.filter(lesson => 
                            lesson.time && lesson.time.includes('-') && !lesson.status
                        );

                        html += `
                            <div style="margin-bottom: 15px; text-align: center;">
                                <strong>–ù–∞–π–¥–µ–Ω–æ –∑–∞–Ω—è—Ç–∏–π: ${activeLessons.length}</strong>
                            </div>
                        `;

                        activeLessons.forEach(lesson => {
                            html += `
                                <div class="lesson-card">
                                    <div class="lesson-time">${lesson.time || 'N/A'}</div>
                                    <div class="lesson-details">
                                        <strong>${lesson.subject || '–ó–∞–Ω—è—Ç–∏–µ'}</strong><br>
                                        ${lesson.room ? `<span class="lesson-room"> ${lesson.room}</span>` : ''}
                                        ${lesson.group ? `<span class="lesson-group"> ${lesson.group}</span>` : ''}
                                        ${lesson.subgroup ? ` <small>(${lesson.subgroup})</small>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                    }
                }

                html += '</div>';
                resultsDiv.innerHTML = html;
            }

            // Load teachers on page load
            fetchTeachers();

            // Offline/Online detection
            const offlineIndicator = document.getElementById('offline-indicator');
            
            function updateOfflineStatus() {
                if (!navigator.onLine) {
                    offlineIndicator.classList.add('show');
                } else {
                    offlineIndicator.classList.remove('show');
                }
            }

            window.addEventListener('online', updateOfflineStatus);
            window.addEventListener('offline', updateOfflineStatus);
            updateOfflineStatus();

            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('[Service Worker] Registered:', registration.scope);
                        
                        // –ö—ç—à–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –¥—Ä—É–≥–∏–µ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        if (registration.active || registration.installing) {
                            const pagesToCache = [
                                window.location.href,
                                '/gui',
                                '/searchStudent',
                                '/searchTeacher'
                            ];
                            
                            pagesToCache.forEach(pageUrl => {
                                fetch(pageUrl, { credentials: 'same-origin' })
                                    .then(response => {
                                        if (response.ok) {
                                            return caches.open('plapser-static-v1').then(cache => {
                                                return cache.put(pageUrl, response);
                                            });
                                        }
                                    })
                                    .catch(err => console.log(`[SW] Failed to cache ${pageUrl}:`, err));
                            });
                        }
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            console.log('[Service Worker] Update found');
                        });
                    })
                    .catch((error) => {
                        console.error('[Service Worker] Registration failed:', error);
                    });
            }

            // Show install prompt if available
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('[PWA] Install prompt available');
            });

            window.addEventListener('appinstalled', () => {
                console.log('[PWA] App installed');
                deferredPrompt = null;
            });

            // Update time display
            const updateTimeDiv = document.getElementById('update-time');
            
            function showUpdateTime(timestamp) {
                if (!updateTimeDiv) return;
                
                const now = Date.now();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                
                let timeText;
                if (minutes < 1) {
                    timeText = '—Å–µ–π—á–∞—Å';
                } else if (minutes < 60) {
                    timeText = `${minutes} –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥`;
                } else if (hours < 24) {
                    timeText = `${hours} —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥`;
                } else {
                    const date = new Date(timestamp);
                    timeText = `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${date.toLocaleString('ru-RU', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}`;
                }
                
                updateTimeDiv.textContent = timeText;
                updateTimeDiv.style.display = 'block';
                
                // –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –µ—Å–ª–∏ –±–æ–ª—å—à–µ 2 —á–∞—Å–æ–≤
                if (hours >= 2) {
                    updateTimeDiv.classList.add('stale');
                } else {
                    updateTimeDiv.classList.remove('stale');
                }
            }

            // Update progress display
            const updateProgressDiv = document.getElementById('update-progress');
            let updateProgress = {
                current: null,
                startTime: null,
                total: 0,
                completed: 0
            };

            function showUpdateProgress(item, itemType, total) {
                if (!updateProgressDiv) return;
                
                updateProgress.current = item;
                updateProgress.total = total;
                if (!updateProgress.startTime) {
                    updateProgress.startTime = Date.now();
                }
                
                updateProgressDiv.classList.add('show');
                updateProgressDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${itemType === 'group' ? '–≥—Ä—É–ø–ø–∞' : '–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å'} ${item}...`;
            }

            function hideUpdateProgress() {
                if (!updateProgressDiv) return;
                
                if (updateProgress.startTime) {
                    const duration = ((Date.now() - updateProgress.startTime) / 1000).toFixed(1);
                    updateProgressDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ ${duration}—Å`;
                    setTimeout(() => {
                        updateProgressDiv.classList.remove('show');
                        updateProgress.startTime = null;
                        updateProgress.current = null;
                        updateProgress.total = 0;
                        updateProgress.completed = 0;
                    }, 2000);
                } else {
                    updateProgressDiv.classList.remove('show');
                }
            }

            // Background update on app open
            async function startBackgroundUpdate() {
                if (!navigator.onLine) {
                    console.log('[Client] Background update skipped - offline');
                    return;
                }

                const recentGroups = [];
                const recentTeachers = getRecentTeachers();
                
                if (recentGroups.length === 0 && recentTeachers.length === 0) {
                    return;
                }

                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'START_BACKGROUND_UPDATE',
                        recentGroups: recentGroups,
                        recentTeachers: recentTeachers
                    });
                }
            }

            // Listen for messages from Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'CACHE_UPDATED') {
                        const { item, itemType, total } = event.data;
                        showUpdateProgress(item, itemType, total || 12);
                    } else if (event.data.type === 'CACHE_UPDATE_COMPLETE') {
                        hideUpdateProgress();
                    } else if (event.data.type === 'GET_RECENT_ITEMS') {
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ Service Worker
                        if (navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage({
                                type: 'GET_RECENT_ITEMS_RESPONSE',
                                recentGroups: [],
                                recentTeachers: getRecentTeachers()
                            });
                        }
                    }
                });
            }

            // Start background update on page load
            startBackgroundUpdate();

            // Update on online
            window.addEventListener('online', () => {
                console.log('[Client] Online - starting background update');
                startBackgroundUpdate();
            });
        });

        // Theme functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.body;
            
            // Load saved theme or default to light
            const savedTheme = localStorage.getItem('theme') || 'light';
            body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Theme toggle event listener
            themeToggle.addEventListener('click', function() {
                const currentTheme = body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });
            
            function updateThemeIcon(theme) {
                themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                themeToggle.title = theme === 'dark' ? '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É' : '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É';
            }
        });
    </script>
</body>

</html>
